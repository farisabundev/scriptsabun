#!/bin/zsh
# === ms (merge safe) ===

source "$(dirname "$0")/_colors.zsh"

# === CONFIG ===
TARGET_BRANCH=$1

if [ -z "$TARGET_BRANCH" ]; then
  echo "${RED}‚ùå Please provide a target branch.${RESET}"
  echo "Usage: ${YELLOW}ms <target-branch>${RESET}"
  exit 1
fi

CURRENT_BRANCH=$(git branch --show-current)

if [ -z "$CURRENT_BRANCH" ]; then
  echo "${RED}‚ùå Not inside a Git repository.${RESET}"
  exit 1
fi

echo "${CYAN}üì¶ Current branch:${RESET} $CURRENT_BRANCH"
echo "${CYAN}üéØ Target branch:${RESET} $TARGET_BRANCH"

# === STASH UNCOMMITTED CHANGES (if any) ===
if ! git diff --quiet || ! git diff --cached --quiet; then
  echo "${YELLOW}üíæ Stashing uncommitted changes...${RESET}"
  git stash push -u -m "auto-stash-before-merge-to-$TARGET_BRANCH"
  STASHED=true
fi

# === SWITCH TO TARGET BRANCH ===
echo "${BLUE}üîÑ Switching to ${TARGET_BRANCH}...${RESET}"
if ! git checkout "$TARGET_BRANCH"; then
  echo "${RED}‚ùå Failed to checkout ${TARGET_BRANCH}.${RESET}"
  exit 1
fi

# === UPDATE TARGET BRANCH ===
echo "${BLUE}‚¨áÔ∏è  Updating ${TARGET_BRANCH}...${RESET}"
git fetch origin "$TARGET_BRANCH"
if ! git pull --rebase; then
  echo "${RED}‚ùå Pull failed. Aborting.${RESET}"
  git checkout "$CURRENT_BRANCH"
  exit 1
fi

# === MERGE CURRENT BRANCH ===
echo "${BLUE}üîÄ Merging ${CURRENT_BRANCH} into ${TARGET_BRANCH}...${RESET}"
if git merge --no-ff "$CURRENT_BRANCH"; then
  echo "${GREEN}‚úÖ Merge successful. Pushing to origin...${RESET}"
  git push origin "$TARGET_BRANCH"
  MERGE_SUCCESS=true
else
  echo "${YELLOW}‚ö†Ô∏è Merge conflict detected!${RESET}"
  echo "${RED}üß© Aborting merge to prevent messy state.${RESET}"
  git merge --abort
  MERGE_SUCCESS=false
fi

# === SWITCH BACK ===
echo "${BLUE}‚Ü©Ô∏è  Returning to ${CURRENT_BRANCH}...${RESET}"
git checkout "$CURRENT_BRANCH"

# === RESTORE STASH IF EXISTS ===
if [ "$STASHED" = true ]; then
  echo "${YELLOW}üìÇ Restoring stashed changes...${RESET}"
  git stash pop || echo "${YELLOW}‚ö†Ô∏è Failed to apply stashed changes.${RESET} Check manually with: ${CYAN}git stash list${RESET}"
fi

# === DONE ===
if [ "$MERGE_SUCCESS" = true ]; then
  echo "${GREEN}üéâ Done! ${CURRENT_BRANCH} successfully merged into ${TARGET_BRANCH} and pushed.${RESET}"
else
  echo "${RED}‚ùå Merge aborted due to conflicts. Please resolve manually.${RESET}"
fi
