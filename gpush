#!/bin/zsh
# === gpush (do i really need to explain u this?) ===

source "$(dirname "$0")/_colors.zsh"

# === FLAG CHECK ===
NO_ADD=false
SET_UPSTREAM=false

# Parse flags
for arg in "$@"; do
  case $arg in
    -na|--no-add)
      NO_ADD=true
      shift
      ;;
    -su|--set-upstream)
      SET_UPSTREAM=true
      shift
      ;;
  esac
done

# === COMMIT MESSAGE CHECK ===
if [ -z "$1" ]; then
  echo "${RED}‚ùå Please provide a commit message.${RESET}"
  echo "Usage:"
  echo "  gpush \"your message\""
  echo "  gpush -na \"your message\"      # skip git add ."
  echo "  gpush -su \"your message\"      # set upstream if missing"
  exit 1
fi

# === ADD FILES ===
if [ "$NO_ADD" = false ]; then
  echo "${BLUE}üß© Staging all changes...${RESET}"
  git add .
else
  echo "${YELLOW}üö´ Skipping git add .${RESET}"
fi

# === PREVENT EMPTY COMMIT ===
if git diff --cached --quiet; then
  echo "${RED}‚ùå No staged changes to commit.${RESET}"
  echo "${YELLOW}Hint:${RESET} Stage your files or remove the --no-add flag."
  exit 1
fi

# === COMMIT AND PUSH ===
echo "${BLUE}üìù Committing changes...${RESET}"
if git commit -m "$1"; then
  echo "${BLUE}üöÄ Pushing to remote...${RESET}"

  if [ "$SET_UPSTREAM" = true ]; then
    CURRENT_BRANCH=$(git branch --show-current)
    echo "${YELLOW}üåê Setting upstream for branch '${CURRENT_BRANCH}'...${RESET}"
    if git push --set-upstream origin "$CURRENT_BRANCH"; then
      echo "${GREEN}‚úÖ Upstream set and pushed successfully!${RESET}"
    else
      echo "${RED}‚ùå Failed to set upstream or push.${RESET}"
    fi
  else
    if git push; then
      echo "${GREEN}‚úÖ Successfully pushed to remote!${RESET}"
    else
      echo "${RED}‚ùå Push failed. Try using -su if this branch has no upstream.${RESET}"
    fi
  fi

else
  echo "${RED}‚ùå Commit failed.${RESET}"
fi
